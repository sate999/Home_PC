/* ============================================================
 * pipe_basic.c - 파이프 기본 예제 (주석 있는 버전)
 * 
 * 기능: 부모 프로세스가 파이프를 통해 자식에게 메시지 전송
 * 컴파일: gcc -o pipe_basic pipe_basic.c
 * 실행: ./pipe_basic
 * 
 * 출력 예시:
 * Hello, world
 * ============================================================ */

#include <stdio.h>      /* fprintf, puts 함수 사용 */
#include <unistd.h>     /* pipe, fork, read, write, close 함수 사용 */
#include <stdlib.h>     /* exit 함수 사용 */

#define MSGSIZE 20      /* 메시지 버퍼 크기 정의 */

int main () {
    int fd[2], pid;     /* fd[0]: 읽기용, fd[1]: 쓰기용 파일 디스크립터 */
    char msgin[MSGSIZE], msgout[MSGSIZE] = "\nHello, world\n";  /* 입출력 버퍼 */
    
    /* --------------------------------------------------------
     * pipe() 시스템 콜
     * - fd[0]: 파이프에서 데이터를 읽기 위한 파일 디스크립터
     * - fd[1]: 파이프에 데이터를 쓰기 위한 파일 디스크립터
     * - 실패 시 -1 반환
     * -------------------------------------------------------- */
    if (pipe(fd) == -1) { 
        fprintf (stderr, "error\n");    /* 파이프 생성 실패 시 에러 메시지 */
        exit(1);                        /* 프로그램 종료 */
    }
    
    /* --------------------------------------------------------
     * fork() 시스템 콜
     * - 자식 프로세스 생성
     * - 부모에게는 자식의 PID 반환 (양수)
     * - 자식에게는 0 반환
     * - 실패 시 -1 반환
     * -------------------------------------------------------- */
    if ((pid = fork()) > 0) {           /* 부모 프로세스 */
        close (fd[0]);                  /* 읽기용 디스크립터 닫기 (사용 안함) */
        write (fd[1], msgout, MSGSIZE); /* 파이프에 메시지 쓰기 */
    }
    else if (pid == 0) {                /* 자식 프로세스 */
        close (fd[1]);                  /* 쓰기용 디스크립터 닫기 (사용 안함) */
        read (fd[0], msgin, MSGSIZE);   /* 파이프에서 메시지 읽기 */
        puts (msgin);                   /* 읽은 메시지 화면에 출력 */
    }
    
    return 0;
}