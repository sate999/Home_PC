/* ============================================================
 * client.c - Named Pipe 파일 클라이언트 (주석 있는 버전)
 * 
 * 기능: 서버에게 파일 요청하고 받은 내용을 화면에 출력
 * 컴파일: gcc -o client client.c
 * 실행: ./client <파일이름>
 * 예시: ./client data
 * 
 * 동작 순서:
 * 1. 개인 FIFO 파이프 생성 (Fifo + PID)
 * 2. Public 파이프에 요청 메시지 write
 * 3. 개인 FIFO에서 파일 내용 read
 * 4. 화면에 출력
 * 5. 개인 FIFO 삭제
 * ============================================================ */

#include "namedPipe.h"

int main (int argc, char *argv[]) {
    struct message msg;
    int n, fdpub, fdpriv;
    char line[LINESIZE];
    
    /* --------------------------------------------------------
     * 메시지 구조체 설정
     * - filename: 읽고 싶은 파일 이름 (argv[1])
     * - privfifo: 개인 파이프 이름 (Fifo + 현재 프로세스 PID)
     * -------------------------------------------------------- */
    strcpy (msg.filename, argv[1]);             /* 파일 이름 복사 */
    sprintf (msg.privfifo, "Fifo%d", getpid()); /* 개인 파이프 이름 생성 */
    
    /* --------------------------------------------------------
     * 개인 FIFO 파이프 생성
     * - mknod로 named pipe 파일 생성
     * - 서버가 이 파이프로 파일 내용을 보내줌
     * -------------------------------------------------------- */
    if (mknod (msg.privfifo, S_IFIFO | 0666, 0) == -1) {
        perror(msg.privfifo);
        exit(1);
    }
    
    /* --------------------------------------------------------
     * Public 파이프 열기 (쓰기 전용)
     * - 서버가 읽기 전용으로 열어놓은 파이프
     * -------------------------------------------------------- */
    if ((fdpub = open (PUBLIC, O_WRONLY)) == -1) {
        perror (PUBLIC);
        exit(2);
    }
    
    /* --------------------------------------------------------
     * 서버에게 요청 메시지 전송
     * - msg 구조체를 Public 파이프에 write
     * - 서버는 이 메시지를 읽고 파일을 보내줌
     * -------------------------------------------------------- */
    write (fdpub, (char *) &msg, sizeof(msg));
    
    /* --------------------------------------------------------
     * 개인 FIFO 열기 (읽기 전용)
     * - 서버가 파일 내용을 여기로 보내줌
     * -------------------------------------------------------- */
    if ((fdpriv = open (msg.privfifo, O_RDONLY)) ==-1) {
        perror (msg.privfifo);
        exit(3);
    }
    
    /* --------------------------------------------------------
     * 개인 FIFO에서 파일 내용 읽어서 화면에 출력
     * - read가 0 반환하면 EOF (서버가 전송 완료)
     * -------------------------------------------------------- */
    while ((n=read (fdpriv, line, LINESIZE)) > 0)
        write (1, line, n);     /* stdout(1)에 출력 */
    
    /* --------------------------------------------------------
     * 정리 작업
     * - 개인 FIFO 닫기
     * - 개인 FIFO 파일 삭제 (unlink)
     * -------------------------------------------------------- */
    close (fdpriv);
    unlink (msg.privfifo);      /* 개인 파이프 파일 삭제 */
    
    exit(0);
}